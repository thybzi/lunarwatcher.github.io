<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-language content="en-US"><title>Matrix mouse picking | Olivia's blog</title><script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
<link rel=stylesheet type=text/css href=https://lunarwatcher.github.io/scss/style.min.css><link rel=alternate type=application/rss+xml title="Olivia's blog" href=https://lunarwatcher.github.io/blog/feed.xml><meta property="og:title" content="Matrix mouse picking"><meta property="og:url" content="https://lunarwatcher.github.io/newsletter.html"></head><body><header><nav class=nav-container><div class=container><h1 class="logo left"><a href=/>Olivia</a></h1><div id=sidenav class=sidenav><a href=javascript:void(0) class=close onclick=closeSidenav()>&#215;</a>
<a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><div class="topnav right"><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><span class=sidenav-trigger onclick=openSidenav()>&#9776;</span></div></nav></header><main><div class=container id=content><h1>Matrix mouse picking</h1><span class=post-meta>Posted on July 18th, 2021</span>
<span class=post-meta>Tags:
<a class=post-tag href=https://lunarwatcher.github.io/tags/c++.html>#c++</a>, <a class=post-tag href=https://lunarwatcher.github.io/tags/mouse-picking.html>#mouse picking</a>, <a class=post-tag href=https://lunarwatcher.github.io/tags/opengl.html>#opengl</a></span><br><p><code>glm::unProject</code> is a fucking lifesaver.</p><p>For it to work properly, <code>GL_DEPTH_TEST</code> has to be enabled. This allows <code>glGetPixels()</code> to return a value != 1 for <code>GL_DEPTH_COMPONENT</code>, which is necessary to unproject the correct coordinates.</p><p>The documentation for <code>unProject</code> is trash. It claims the second parameter is a model-view matrix (<code>model * view</code>, or as I like to call it, <code>transMatrix * camMatrix</code>), or just a model matrix. Obligatory reminder that the model matrix is primarily used to transform the position of an <em>object</em>, which doesn't really matter.</p><p>Secondly, common pitfall (thank you compsci - how many coord systems do you possibly need for computer graphics?), this OpenGL call takes the window coordinates, which are relative to the bottom-left corner. Not the top-right, not [-1, 1] relative to the center of the window. The Z is also critical, which is why <code>GL_DEPTH_TEST</code> is needed. This also requires clearing <code>GL_DEPTH_BUFFER_BIT</code>, or shit breaks.</p><p>The coordinate system being weird means that the dimensions of the window need to be known. This can be found with <code>glViewport</code>, but storing what the window is created with is a better and more optimized idea. The dimensions are required for <code>glm::unProject</code> anyway.</p><p>Overly documented code (MIT-licensed; see the Genesis repo for the license):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>// This method can be called directly from the mouse event listener.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>glm</span><span class=o>::</span><span class=n>vec2</span> <span class=n>Camera</span><span class=o>::</span><span class=n>convertToWorld</span><span class=p>(</span><span class=kt>double</span> <span class=n>mouseX</span><span class=p>,</span> <span class=kt>double</span> <span class=n>mouseY</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Pre-declaration of the variable used for glReadPixels
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GLfloat</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// these might be useless. Could probably get away with mouseY = 576 - mouseY
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 576 is the height of the window
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>GLfloat</span> <span class=n>x</span> <span class=o>=</span> <span class=n>mouseX</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>y</span> <span class=o>=</span> <span class=mi>576</span> <span class=o>-</span> <span class=n>mouseY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>glReadPixels</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>GL_DEPTH_COMPONENT</span><span class=p>,</span> <span class=n>GL_FLOAT</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>glm</span><span class=o>::</span><span class=n>vec2</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>glm</span><span class=o>::</span><span class=n>unProject</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>glm</span><span class=o>::</span><span class=n>vec3</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>x</span><span class=p>,</span> <span class=c1>// The x position. Again, in screen coordinates relative to the bottom-left, not OpenGL coords
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>y</span><span class=p>,</span> <span class=c1>// The y position. Same as the x position
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>z</span> <span class=c1>// The z-position, as received from glReadPixels.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=o>-&gt;</span><span class=n>matrix</span><span class=p>,</span> <span class=c1>// Horribly named, but this is the camera matrix. It&#39;s created with glm::lookAt
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=c1>// in my project, but this is a many ways to rome-situation.
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=c1>// As long as it&#39;s the matrix used to represent the translation and rotation of
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=c1>// the camera, that&#39;s all you need.
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=c1>// Like I mentioned earlier, no need for a model matrix - only a camera
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=c1>// matrix.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>this</span><span class=o>-&gt;</span><span class=n>perspectiveMatrix</span><span class=p>,</span> <span class=c1>// The perspective matrix. May also be an ortho matrix or another form
</span></span></span><span class=line><span class=cl><span class=c1></span>                                     <span class=c1>// of perspective matrix.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>glm</span><span class=o>::</span><span class=n>vec4</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=c1>// I have no idea what these two numbers mean.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=mf>1024.0</span><span class=p>,</span> <span class=c1>// width
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=mf>576.0</span><span class=p>}</span> <span class=c1>// height
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>As a side-note, I imagine this is only useful if there isn't a 1:1 world matrix. In Genesis, I use an ortho matrix for text rendering, and it (should) use the same dimensions as the screen. If the UI uses coords that match the window size, there's no need to unproject to do collision testing.</p><p>Adding UI handling is potentially done without converting to world coordinates. I'll have to revisit this at a later time.</p><p>The live and updated version is available in the repo for <a href=https://github.com/LunarWatcher/Genesis/blob/master/src/genesis/rendering/view/Camera.cpp>Genesis</a> (<code>Camera.cpp</code>, <code>convertToWorld(double mouseX, double mouseY)</code>)</p><div class=comments><hr><h2 style=padding-top:20px!important>Comments</h2><i><p>All comments posted either through utteranc.es or manually on the associated GitHub issue end up on an associated issue in the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io>website GitHub repo</a>, and as such are required to follow the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/.github/CODE_OF_CONDUCT.md>project code of conduct</a>. Remember this while writing comments.</p></i><script src=https://utteranc.es/client.js repo=LunarWatcher/lunarwatcher.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script><noscript>You've disabled JavaScript, which the comment system makes use of to load them on the site. The comment threads can be found <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/issues>in the issues for this repo</a>, if you don't trust this site and/or utterances. Note that unless someone has already commented, there isn't an issue made for this page yet.</noscript></div></div></main><footer class=page-footer><div class=footer-copyright><div class=container style=overflow:auto>&copy; Olivia, 2019-2021
(<a href=https://github.com/LunarWatcher/LunarWatcher.github.io/tree/master>Website source</a>, <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/LICENSE>license</a>)<p class=right>Powered by <a href=https://gohugo.io/>Hugo</a>
(<a href=javascript:uwu() id=uwu>UwU?</a>)</p></div></div></footer><script type=text/javascript src=https://lunarwatcher.github.io/js/functions.min.js></script></body></html>
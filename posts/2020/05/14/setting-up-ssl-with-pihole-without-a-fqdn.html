<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-language content="en-US"><title>Setting up SSL with pihole, without a FQDN | Olivia's blog</title><script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
<link rel=stylesheet type=text/css href=https://lunarwatcher.github.io/scss/style.min.css><link rel=alternate type=application/rss+xml title="Olivia's blog" href=https://lunarwatcher.github.io/blog/feed.xml><meta property="og:title" content="Setting up SSL with pihole, without a FQDN"><meta property="og:url" content="https://lunarwatcher.github.io/newsletter.html"></head><body><header><nav class=nav-container><div class=container><h1 class="logo left"><a href=/>Olivia</a></h1><div id=sidenav class=sidenav><a href=javascript:void(0) class=close onclick=closeSidenav()>&#215;</a>
<a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><div class="topnav right"><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><span class=sidenav-trigger onclick=openSidenav()>&#9776;</span></div></nav></header><main><div class=toc-container><div class=toc><h2>Table of contents</h2><div><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#disclaimer>Disclaimer</a></li><li><a href=#setting-up-the-dns>Setting up the DNS</a></li><li><a href=#setting-up-the-certificate>Setting up the certificate</a></li><li><a href=#setting-up-lighttpd>Setting up lighttpd</a><ul><li><a href=#fixing-verification-issues-trusting-your-own-ca-root-certificate>Fixing verification issues: trusting your own CA root certificate</a></li></ul></li><li><a href=#renewing-the-ca-and-certificate>Renewing the CA and certificate</a></li></ul></nav></div></div></div><div class=container id=content><h1>Setting up SSL with pihole, without a FQDN</h1><span class=post-meta>Posted on May 14th, 2020</span>
<span class=post-meta>Tags:
<a class=post-tag href=https://lunarwatcher.github.io/tags/pihole.html>#pihole</a>, <a class=post-tag href=https://lunarwatcher.github.io/tags/linux.html>#linux</a></span><br><h2 id=introduction>Introduction</h2><p>This post aims to present an alternative way to generate SSL certificates for your pihole web interface. This is specifically targeted at people without a FQDN (Fully Qualified Domain Name), regardless of whether pihole is hosted locally or on a VPS. Note that this has only tested on a locally hosted pihole instance, running on a Raspberry Pi 3B+. As usual, apply common sense before running commands from strangers on the internet - just because it worked on my system, doesn't necessarily mean it'll work in general. While we're at it, if this is properly configured, it shouldn't cause any problems. Even an invalid SSL certificate would just affect your connection, and not something like SSH or pihole in general.</p><p>There's many reasons to set up HTTPS. Setting it up on a local network has arguably fewer. Personally, my main reason for setting up HTTPS on a local network is that I don't feel comfortable sending a password to something rather personal over an unencrypted connection when I can't be check if there's a reason to worry.</p><p>Obviously, everyone has their own reasons, and while we can argue all day about the legitimacy of various worries, why bother? Worst case scenario, the encryption is unnecessary. Peace of mind is priceless.</p><p>There's already an <a href=https://discourse.pi-hole.net/t/enabling-https-for-your-pi-hole-web-interface/5771>official guide</a> on this, but it uses LetsEncrypt, which doesn't support local domains. The code in this guide, specifically related to <code>/etc/lighttpd/external.conf</code>, is still used and has been slightly adapted. <strong>If you have a FQDN, use the official guide, and not this</strong>. This here assumes you're running a system that prevents you from having a FQDN, and want an alternative.</p><p><strong>Note</strong>: this approach uses self-signed certificates, which most browsers don't trust. There's also a script, which I'll attach at the end of the post, for regenerating the CA and certificate, without breaking it. (Tested locally; different sha1 sums on the CA, but no need to reload it)</p><p>Additionally, this requires some familiarity with the command line, and assumes you already have pihole up and running, and in an accessible state. The only package you need for this is <code>openssl</code>, which you most likely already have.</p><h2 id=disclaimer>Disclaimer</h2><p>This is <strong>not</strong> meant as a perfect, 100% guaranteed to work guide. This post exists to share what I found while trying to deal with this heavily underdocumented aspect of getting HTTPS to work. This may not work in your specific case, and may break in the future.</p><h2 id=setting-up-the-dns>Setting up the DNS</h2><p>First off, you need your "domain". This "domain" isn't actually a domain, but a local DNS record. A domain is just a string of text that gets converted to an IP by a DNS provider, but this one only works if you're using pihole as your DNS. There's probably a way to set this up with an IP as well, but since the HTTPS cert is used for the dashboard, it shouldn't break much. If you can connect to the dashboard, you can probably connect through SSH or connect the DNS.</p><p><img src=/img/pihole-local-dns-records.png alt="image showing the local DNS records settings page in the pihole web interface"></p><p>To set this up, you need to open the pihole dashboard, and log in. There's probably a way to do this from the command line, but I personally wanted a simple solution. Go to the "Local DNS settings" option in the left navbar. This lets you add custom DNS lookup rules. Fill in the domain field with whatever domain you want to use, and the IP with the IP of the pihole device. In my case, I used <code>pihole.lan</code>, and with my Raspberry Pi hosted on <code>192.168.11.216</code>. This is an internal IPv4 address; if you're running pihole on a VPS, you use the IP of your VPS.</p><p>Now, verify that it works. Type the address into a browser on a unit connected to pihole. If you connect, you're good. Otherwise, there's most likely a configuration error somewhere. Note that if the latter happens, it could be because of the TLD. Picking <code>.local</code> <em>does not work</em> on Linux-based computers. <a href=https://unix.stackexchange.com/a/457525/398922>It's a pain</a>, and while there are ways to fix it, it's a lot easier just using a different TLD. Strictly speaking, you don't need a TLD, but this is something you can play around with on your own.</p><p>Whatever you end up with, make sure you stay with it, because you'll need it.</p><h2 id=setting-up-the-certificate>Setting up the certificate</h2><p>This is the part that took a while to figure out. The main advantage with using LetsEncrypt over self-signing is that it uses a CA that's trusted in most browsers out of the box. Self-signing requires manually adding the root CA to your browser or device for it to be supported. If you don't, your browser will warn you that the certificate couldn't be verified - all the usual boring stuff. These can be ignored, but if you're like me and prefer not having warnings, I'll be getting back to that soon.</p><p>To make a long story short, here's a shell (<code>.sh</code>) script for generating the certs:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Meta: certificate locations</span>
</span></span><span class=line><span class=cl><span class=c1># The certificate for the site</span>
</span></span><span class=line><span class=cl><span class=nv>cert</span><span class=o>=</span>crt.pem
</span></span><span class=line><span class=cl><span class=c1># The private key for the site</span>
</span></span><span class=line><span class=cl><span class=nv>certPk</span><span class=o>=</span>pk.pem
</span></span><span class=line><span class=cl><span class=c1># The Certificate Authority (CA) certificate</span>
</span></span><span class=line><span class=cl><span class=nv>ca</span><span class=o>=</span>ca.crt.pem
</span></span><span class=line><span class=cl><span class=c1># The CA private key</span>
</span></span><span class=line><span class=cl><span class=nv>caPk</span><span class=o>=</span>ca.pk.pem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Replace the host with whatever URL you chose.</span>
</span></span><span class=line><span class=cl><span class=c1># If you&#39;re using pihole.lan too, this line doesn&#39;t need to be changed.</span>
</span></span><span class=line><span class=cl><span class=nv>host</span><span class=o>=</span>pihole.lan
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># This defines how long the cert is valid.</span>
</span></span><span class=line><span class=cl><span class=c1># This can be redefined, but I personally keep it at 365 days.</span>
</span></span><span class=line><span class=cl><span class=c1># Since this requires renewing, and not regenerating, this script</span>
</span></span><span class=line><span class=cl><span class=c1># is only useful for the initial generation, or re-creating the</span>
</span></span><span class=line><span class=cl><span class=c1># entire thing, if you feel like it.</span>
</span></span><span class=line><span class=cl><span class=nv>certValidityDays</span><span class=o>=</span><span class=m>365</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a CA</span>
</span></span><span class=line><span class=cl>openssl req -newkey rsa:4096 -keyout <span class=s2>&#34;</span><span class=si>${</span><span class=nv>caPk</span><span class=si>}</span><span class=s2>&#34;</span> -x509 -new -nodes -out <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ca</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -subj <span class=s2>&#34;/OU=Unknown/O=Unknown/L=Unknown/ST=unknown/C=AU&#34;</span> -days <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certValidityDays</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create a Cert Signing Request</span>
</span></span><span class=line><span class=cl>openssl req -new -newkey rsa:4096 -nodes -keyout <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certPk</span><span class=si>}</span><span class=s2>&#34;</span> -out csr.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -subj <span class=s2>&#34;/CN=</span><span class=si>${</span><span class=nv>host</span><span class=si>}</span><span class=s2>/OU=Unknown/O=Unknown/L=Unknown/ST=unknown/C=AU&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sign the certificate</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in csr.pem -CA <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ca</span><span class=si>}</span><span class=s2>&#34;</span> -CAkey <span class=s2>&#34;</span><span class=si>${</span><span class=nv>caPk</span><span class=si>}</span><span class=s2>&#34;</span> -CAcreateserial -out <span class=s2>&#34;</span><span class=si>${</span><span class=nv>cert</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -days <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certValidityDays</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># See the official post; it requires the private and public key merged into a combined file</span>
</span></span><span class=line><span class=cl>cat <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certPk</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>cert</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> tee ./combined.pem
</span></span></code></pre></div><p>Personally, I chucked this script, along with the certificates, into <code>/etc/sslcerts</code> (<code>mkdir</code> it if it doesn't exist). If OpenSSL fails to read/write, you'll need to chown the folder, or just call the script with sudo.</p><p>When it's done, you'll be left with a folder containing various keys. The only ones you need to notice are <code>ca.crt.pem</code> and <code>combined.pem</code>. These are important for the next step; linking it to lighttpd.</p><h2 id=setting-up-lighttpd>Setting up lighttpd</h2><p>Now that you have your certs, you'll need to link it to lighttpd. Note that syntax errors in the <code>/etc/lighttpd/external.conf</code> file will prevent lighttpd from starting, and it doesn't have sensible error messages in its output. (Tested when I accidentally misplaced a single quote where there shouldn't have been a single quote)</p><p>Anyway, this code is heavily based on the code in <a href=https://discourse.pi-hole.net/t/enabling-https-for-your-pi-hole-web-interface/5771>the official forum</a>, but with two differences. For good measure (avoiding copyright issues), I'm not including the entire block of code. <code>sudo nano /etc/lighttpd/external.conf</code> lets you edit it. Feel free to replace nano with your favorite editor - it really doesn't matter.</p><p>First of all, make sure <code>pihole.example.com</code> is replaced with the URL you picked. If you don't, or this URL is wrong, lighttpd won't serve you an https certificate. Now, for the two changes: these apply to <code>ssl.pemfile</code> and <code>ssl.ca-file</code>. <code>pemfile</code> is, as you might expect, the combined certificate (<code>combined.pem</code>). The <code>ca-file</code> on the other hand, is the ca certificate. This is needed to help with certificate verification, which again, I'll get back to later.</p><p>Here's how you might change the two lines:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nx>ssl</span><span class=o>.</span><span class=nx>pemfile</span> <span class=o>=</span> <span class=s2>&#34;/etc/sslcerts/combined.pem&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>ssl</span><span class=o>.</span><span class=nx>ca</span><span class=o>-</span><span class=nx>file</span> <span class=o>=</span>  <span class=s2>&#34;/etc/sslcerts/ca.crt.pem&#34;</span>
</span></span></code></pre></div><p>These paths assume you stored the SSL certificates in <code>/etc/sslcerts</code>, and that the names are unchanged. If you've changed either the path or file names, make the appropriate changes in the paths.</p><p>Now, when you've gotten <code>external.conf</code> set up, all you need to do is restart lighttpd.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo systemctl restart lighttpd.service
</span></span></code></pre></div><p>Assuming it successfully restarts, you can connect to your dashboard's HTTPS enabled URL, and you should connect over HTTPS. If your browser complains that the connection isn't secure because of an invalid issuer, that's fine. It's an artifact of self-signing a certificate that can't be bypassed in any other way than trusting the CA.</p><h3 id=fixing-verification-issues-trusting-your-own-ca-root-certificate>Fixing verification issues: trusting your own CA root certificate</h3><p>With Firefox, it'll warn you that your connection may not be secure, because it doesn't recognize the CA. In fact, if you go into Firefox' settings and search for "authori" and click "view certificates", you get a list of trusted CA root certificates. Since you made your own with this specific approach, it means it wasn't signed with any of the supported ones, and Firefox warns you.</p><p>With Firefox, you can in the same menu, add your own certificates to trust. Regardless of how you decide to trust the CA, the point is that you need to grab <code>ca.crt.pem</code> over on your device, and add it to a list of trusted root certificates. There's many ways to do this, an depending on your OS, and where you want to trust it (browser or OS), there's different solutions. Note that you need <code>ca.crt.pem</code> for this, regardless of which approach you pick. You can also chose to suppress the warning if you're using a browser, if you prefer that.</p><p>And if everything has been set up properly, pihole's dashboard should work with https:</p><p><img src=/img/ssl-successful.png alt="image showing the pihole dashboard running on an HTTPS url"></p><h2 id=renewing-the-ca-and-certificate>Renewing the CA and certificate</h2><p>This is more of an appendix than a requirement. Depending on how long you set the certificate to be valid for, you might have to renew it at some point. Since the CA itself has a validity period as well, you can't use the same script you used to generate the keys in the first place. Doing this will completely change the root CA, so if you have a browser that explicitly trusts the CA, it will break the site.</p><p>As far as I know, you'll need to trust the new CA when you regenerate it. As long as the old CA is valid, it won't cause problems, but if it's after, it might break stuff. I'm not sure about this, however, and I have no good way to test it, so take this part with a grain of salt. This is based on <a href=https://serverfault.com/a/308100/569995>this ServerFault post</a> by <a href=https://serverfault.com/users/72586/shane-madden>Shane Madden</a>, and the general idea is to renew the CA certificate, and not regenerate it. Of course, regenerating the entire thing is an option.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Same as in the last script</span>
</span></span><span class=line><span class=cl><span class=nv>cert</span><span class=o>=</span>crt.pem
</span></span><span class=line><span class=cl><span class=nv>certPk</span><span class=o>=</span>pk.pem
</span></span><span class=line><span class=cl><span class=nv>ca</span><span class=o>=</span>ca.crt.pem
</span></span><span class=line><span class=cl><span class=nv>caPk</span><span class=o>=</span>ca.pk.pem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Also the same as in the last script</span>
</span></span><span class=line><span class=cl><span class=nv>host</span><span class=o>=</span>pihole.lan
</span></span><span class=line><span class=cl><span class=nv>certValidityDays</span><span class=o>=</span><span class=m>365</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Regenerate CA</span>
</span></span><span class=line><span class=cl><span class=c1># Note that this reuses the old ca.pk.pem, which is the CA private key</span>
</span></span><span class=line><span class=cl>openssl req -new -key <span class=s2>&#34;</span><span class=si>${</span><span class=nv>caPk</span><span class=si>}</span><span class=s2>&#34;</span> -out csr.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -subj <span class=s2>&#34;/OU=Unknown/O=Unknown/L=Unknown/ST=Unknown/C=AU&#34;</span>
</span></span><span class=line><span class=cl>openssl x509 -req -days <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certValidityDays</span><span class=si>}</span><span class=s2>&#34;</span> -in csr.pem -signkey <span class=s2>&#34;</span><span class=si>${</span><span class=nv>caPk</span><span class=si>}</span><span class=s2>&#34;</span> -out <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ca</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Create Cert Signing Request</span>
</span></span><span class=line><span class=cl>openssl req -new -newkey rsa:4096 -nodes -keyout <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certPk</span><span class=si>}</span><span class=s2>&#34;</span> -out csr.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -subj <span class=s2>&#34;/CN=</span><span class=si>${</span><span class=nv>host</span><span class=si>}</span><span class=s2>/OU=Unknown/O=Unknown/L=Unknown/ST=unknown/C=AU&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Sign the certificate</span>
</span></span><span class=line><span class=cl>openssl x509 -req -in csr.pem -CA <span class=s2>&#34;</span><span class=si>${</span><span class=nv>ca</span><span class=si>}</span><span class=s2>&#34;</span> -CAkey <span class=s2>&#34;</span><span class=si>${</span><span class=nv>caPk</span><span class=si>}</span><span class=s2>&#34;</span> -CAcreateserial -out <span class=s2>&#34;</span><span class=si>${</span><span class=nv>cert</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>       -days <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certValidityDays</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cat <span class=s2>&#34;</span><span class=si>${</span><span class=nv>certPk</span><span class=si>}</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>cert</span><span class=si>}</span><span class=s2>&#34;</span> <span class=p>|</span> tee ./combined.pem
</span></span></code></pre></div><div class=comments><hr><h2 style=padding-top:20px!important>Comments</h2><i><p>All comments posted either through utteranc.es or manually on the associated GitHub issue end up on an associated issue in the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io>website GitHub repo</a>, and as such are required to follow the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/.github/CODE_OF_CONDUCT.md>project code of conduct</a>. Remember this while writing comments.</p></i><script src=https://utteranc.es/client.js repo=LunarWatcher/lunarwatcher.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script><noscript>You've disabled JavaScript, which the comment system makes use of to load them on the site. The comment threads can be found <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/issues>in the issues for this repo</a>, if you don't trust this site and/or utterances. Note that unless someone has already commented, there isn't an issue made for this page yet.</noscript></div></div></main><footer class=page-footer><div class=footer-copyright><div class=container style=overflow:auto>&copy; Olivia, 2019-2021
(<a href=https://github.com/LunarWatcher/LunarWatcher.github.io/tree/master>Website source</a>, <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/LICENSE>license</a>)<p class=right>Powered by <a href=https://gohugo.io/>Hugo</a>
(<a href=javascript:uwu() id=uwu>UwU?</a>)</p></div></div></footer><script type=text/javascript src=https://lunarwatcher.github.io/js/functions.min.js></script></body></html>
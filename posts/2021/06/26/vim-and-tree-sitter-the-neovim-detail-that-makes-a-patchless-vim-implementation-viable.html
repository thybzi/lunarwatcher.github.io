<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-language content="en-US"><title>Vim and tree-sitter: the Neovim detail that makes a patchless Vim implementation viable | Olivia's blog</title><script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
<link rel=stylesheet type=text/css href=https://lunarwatcher.github.io/scss/style.min.css><link rel=alternate type=application/rss+xml title="Olivia's blog" href=https://lunarwatcher.github.io/blog/feed.xml><meta property="og:title" content="Vim and tree-sitter: the Neovim detail that makes a patchless Vim implementation viable"><meta property="og:url" content="https://lunarwatcher.github.io/newsletter.html"></head><body><header><nav class=nav-container><div class=container><h1 class="logo left"><a href=/>Olivia</a></h1><div id=sidenav class=sidenav><a href=javascript:void(0) class=close onclick=closeSidenav()>&#215;</a>
<a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><div class="topnav right"><a href=/>Home</a>
<a href=/posts/>Blog</a>
<a href=/tags.html>Tags</a>
<a href=/notes/>Notes</a>
<a href=/emojis.html>Emoji reference</a></div><span class=sidenav-trigger onclick=openSidenav()>&#9776;</span></div></nav></header><main><div class=container id=content><h1>Vim and tree-sitter: the Neovim detail that makes a patchless Vim implementation viable</h1><span class=post-meta>Posted on June 26th, 2021</span>
<span class=post-meta>Tags:
<a class=post-tag href=https://lunarwatcher.github.io/tags/vim.html>#vim</a>, <a class=post-tag href=https://lunarwatcher.github.io/tags/neovim.html>#neovim</a>, <a class=post-tag href=https://lunarwatcher.github.io/tags/treesitter.html>#treesitter</a></span><br><p>Tree-sitter, on paper, is fancy. Near universal highlighting in flexible queries that seems to be a lot more fancy than Vim's standard highlighting. Neovim's implementation is even set up in a way that can be customized further by having built-in highlighting definitions, and tree-sitter highlighting. While not always necessary, it provides the option for extending with additional tree-sitter types, all of which can make some colorschemes more vibrant, without actually breaking it.</p><p>When I looked into what it was when Neovim got it, I didn't look into all the implementation details - that's what this article is going to cover. It was still mildly disappointing: didn't seem to work, it relied on an external plugin... The entire thing was confusing, to say the least.</p><p>Of course, it being confusing is a matter of opinion and background. However, the fact that it is a plugin is how <a href=https://github.com/LunarWatcher/Acacia/>a Vim implementation is viable</a>.</p><p>There's a short version of this in the documentation of the (at the time of writing, work in progress) plugin, but the fact that Neovim allows a plugin to use tree-sitter is the reason it's possible to do in Vim with a bit of effort.</p><p>The detail I mentioned in the title of this article is in how Neovim implemented tree-sitter. In fact, it didn't implement tree-sitter. Neovim itself doesn't use tree-sitter for syntax highlighting. The update that introduced tree-sitter exposed Lua bindings <em>for</em> tree-sitter, meaning the plugin uses the API to access tree-sitter.</p><p>The subtle difference here is that the plugin uses <a href=https://github.com/nvim-treesitter/nvim-treesitter/blob/ddc0f1b606472b6a1ab85ee9becfd4877507627d/lua/nvim-treesitter/ts_utils.lua#L164-L167>Lua functions for range highlighting</a>, and that it uses a wrapper built into Neovim around tree-sitter. That's an important detail as well - wrapper around tree-sitter. Their Lua wrapper is just that: a <a href=https://github.com/neovim/neovim/blob/master/src/nvim/lua/treesitter.c#L1-L6>glorified wrapper</a> with no impact on the highlight features of treesitter, or any other features of tree-sitter. Additionally, tree-sitter <a href=https://github.com/tree-sitter/tree-sitter>is open-source</a> under a permissive license -- there's nothing preventing another implementation.</p><p>This tiny detail means that Neovim's implementation of tree-sitter isn't particularly unique - the only thing a fully external plugin can't do is expose a raw Vimscript API without installing the plugin first. All Neovim did is exposing a Lua API for tree-sitter. This does mean developers can easily use tree-sitter for other plugins, but it also means there's nothing particularly special about Neovim's tree-sitter interface.</p><p>In theory, this means that a tiny bit of code should be able to expose the API to a program that handles the queries, and feeds it back to Vim. Using built-in functions and leveraging async behavior on top of this is more than enough to implement tree-sitter in Vim without a single patch to Vim implementing tree-sitter.</p><p>And that's the theory behind implementing tree-sitter in a Vim plug -- now it's time to actually do it.</p><div class=comments><hr><h2 style=padding-top:20px!important>Comments</h2><i><p>All comments posted either through utteranc.es or manually on the associated GitHub issue end up on an associated issue in the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io>website GitHub repo</a>, and as such are required to follow the <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/.github/CODE_OF_CONDUCT.md>project code of conduct</a>. Remember this while writing comments.</p></i><script src=https://utteranc.es/client.js repo=LunarWatcher/lunarwatcher.github.io issue-term=pathname label=comments theme=github-light crossorigin=anonymous async></script><noscript>You've disabled JavaScript, which the comment system makes use of to load them on the site. The comment threads can be found <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/issues>in the issues for this repo</a>, if you don't trust this site and/or utterances. Note that unless someone has already commented, there isn't an issue made for this page yet.</noscript></div></div></main><footer class=page-footer><div class=footer-copyright><div class=container style=overflow:auto>&copy; Olivia, 2019-2021
(<a href=https://github.com/LunarWatcher/LunarWatcher.github.io/tree/master>Website source</a>, <a href=https://github.com/LunarWatcher/lunarwatcher.github.io/blob/master/LICENSE>license</a>)<p class=right>Powered by <a href=https://gohugo.io/>Hugo</a>
(<a href=javascript:uwu() id=uwu>UwU?</a>)</p></div></div></footer><script type=text/javascript src=https://lunarwatcher.github.io/js/functions.min.js></script></body></html>